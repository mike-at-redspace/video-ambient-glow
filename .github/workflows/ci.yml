name: 'Lint, Test & Build'

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: '${{ github.workflow }}-${{ github.ref }}'
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  FORCE_COLOR: 1

jobs:
  format-check:
    name: 'ðŸ“ Format Check'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - run: npm ci --prefer-offline --no-audit
      - run: npm run format:check

  lint:
    name: 'ðŸ” Lint'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - run: npm ci --prefer-offline --no-audit
      - run: npm run lint:ci

  type-check:
    name: 'ðŸ“˜ Type Check'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - run: npm ci --prefer-offline --no-audit
      - run: npx tsc --noEmit

  test:
    name: 'ðŸ§ª Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - run: npm ci --prefer-offline --no-audit
      - run: npm test
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: 'test-coverage-${{ github.sha }}'
          path: coverage/
          retention-days: 3
          if-no-files-found: warn

  check-changes:
    name: 'ðŸ” Check Changed Files'
    runs-on: ubuntu-latest
    outputs:
      build-main: '${{ steps.src.outputs.changed }}'
      build-example: '${{ steps.example.outputs.changed }}'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Check ./src changes
        id: src
        run: |
          if git diff --quiet HEAD~1 HEAD -- ./src; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      - name: Check ./example changes
        id: example
        run: |
          if git diff --quiet HEAD~1 HEAD -- ./example; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

  build:
    name: 'ðŸ—ï¸ Build'
    runs-on: ubuntu-latest
    needs:
      - format-check
      - lint
      - type-check
      - test
      - check-changes
    if: needs.check-changes.outputs.build-main == 'true'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - run: npm ci --prefer-offline --no-audit
      - run: npm run build
      - name: Verify build artifacts
        run: |
          missing=0
          for file in dist/index.js dist/index.cjs dist/index.umd.js dist/index.d.ts; do
            if [ ! -f "$file" ]; then
              echo "âŒ $file not found"
              missing=1
            else
              echo "âœ… $file"
            fi
          done
          if [ $missing -eq 1 ]; then exit 1; fi
      - name: Report bundle sizes
        run: |
          ESM_SIZE=$(stat -c%s dist/index.js)
          CJS_SIZE=$(stat -c%s dist/index.cjs)
          UMD_SIZE=$(stat -c%s dist/index.umd.js)
          ESM_KB=$(awk "BEGIN {printf \"%.2f\", $ESM_SIZE/1024}")
          CJS_KB=$(awk "BEGIN {printf \"%.2f\", $CJS_SIZE/1024}")
          UMD_KB=$(awk "BEGIN {printf \"%.2f\", $UMD_SIZE/1024}")
          ESM_GZIP=$(gzip -c dist/index.js | wc -c)
          CJS_GZIP=$(gzip -c dist/index.cjs | wc -c)
          UMD_GZIP=$(gzip -c dist/index.umd.js | wc -c)
          ESM_GZIP_KB=$(awk "BEGIN {printf \"%.2f\", $ESM_GZIP/1024}")
          CJS_GZIP_KB=$(awk "BEGIN {printf \"%.2f\", $CJS_GZIP/1024}")
          UMD_GZIP_KB=$(awk "BEGIN {printf \"%.2f\", $UMD_GZIP/1024}")
          printf "%-25s %8s KB (%6s KB gzipped)\n" "ESM (index.js):" "$ESM_KB" "$ESM_GZIP_KB"
          printf "%-25s %8s KB (%6s KB gzipped)\n" "CommonJS (index.cjs):" "$CJS_KB" "$CJS_GZIP_KB"
          printf "%-25s %8s KB (%6s KB gzipped)\n" "UMD (index.umd.js):" "$UMD_KB" "$UMD_GZIP_KB"
      - uses: actions/upload-artifact@v4
        with:
          name: 'build-output-${{ github.sha }}'
          path: dist/
          retention-days: 3

  build-example:
    name: 'ðŸŽ¨ Build Example'
    runs-on: ubuntu-latest
    needs:
      - format-check
      - lint
      - type-check
      - test
      - build
      - check-changes
    if: needs.check-changes.outputs.build-example == 'true'
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - run: npm ci --prefer-offline --no-audit
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: 'build-output-${{ github.sha }}'
          path: dist/
      - run: npm run build:example
      - name: Verify example build
        run: |
          if [ -f "example/dist/index.html" ]; then
            echo "âœ… example/dist/index.html verified"
            EXAMPLE_SIZE=$(du -sh example/dist 2>/dev/null | cut -f1 || echo "unknown")
            echo "ðŸ“Š Example build size: $EXAMPLE_SIZE"
          else
            echo "âŒ example/dist/index.html not found"
            exit 1
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: 'example-build-${{ github.sha }}'
          path: example/dist/
          retention-days: 3

  publish-npm:
    name: 'ðŸ“¦ Publish to npm'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - format-check
      - lint
      - type-check
      - test
      - build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
          registry-url: 'https://registry.npmjs.org'
      - name: Check if version changed
        id: version-check
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          git checkout HEAD~1 -- package.json 2>/dev/null || echo "none"
          PREVIOUS_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "none")
          git checkout HEAD -- package.json
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ] && [ "$PREVIOUS_VERSION" != "none" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      - name: Skip if version unchanged
        if: steps.version-check.outputs.changed == 'false'
        run: echo "â„¹ï¸ Version unchanged â€“ skipping npm publish"
      - name: Publish to npm
        if: steps.version-check.outputs.changed == 'true'
        env:
          NODE_AUTH_TOKEN: '${{ secrets.NPM_TOKEN }}'
        run: |
          npm ci --prefer-offline --no-audit
          npm publish --provenance --access public
      - name: Create Git tag
        if: steps.version-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version-check.outputs.version }}" -m "Release v${{ steps.version-check.outputs.version }}"
          git push origin "v${{ steps.version-check.outputs.version }}"

  ci-summary:
    name: 'âœ… CI Summary'
    runs-on: ubuntu-latest
    needs:
      - format-check
      - lint
      - type-check
      - test
      - build
      - publish-npm
    if: always()
    steps:
      - name: Generate CI summary
        run: |
          echo "# ðŸŽ¯ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ needs.format-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint        | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check  | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test        | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build       | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publish npm | ${{ needs.publish-npm.result }} |" >> $GITHUB_STEP_SUMMARY
