name: Lint, Test & Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  FORCE_COLOR: 1

jobs:
  format-check:
    name: üìù Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci --prefer-offline --no-audit

      - run: npm run format:check

  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci --prefer-offline --no-audit

      - run: npm run lint:ci

  type-check:
    name: üìò Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci --prefer-offline --no-audit

      - run: npx tsc --noEmit

  test:
    name: üß™ Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci --prefer-offline --no-audit

      - run: npm test

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: coverage/
          retention-days: 7

  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [format-check, lint, type-check, test]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci --prefer-offline --no-audit

      - run: npm run build

      - name: Verify build artifacts
        run: |
          for file in dist/index.js dist/index.cjs dist/index.d.ts; do
            [ -f "$file" ] || { echo "‚ùå $file not found"; exit 1; }
          done
          echo "‚úÖ All build artifacts verified"

      - name: Report bundle sizes
        run: |
          ESM_SIZE=$(stat -c%s dist/index.js)
          CJS_SIZE=$(stat -c%s dist/index.cjs)
          ESM_KB=$(awk "BEGIN {printf \"%.2f\", $ESM_SIZE/1024}")
          CJS_KB=$(awk "BEGIN {printf \"%.2f\", $CJS_SIZE/1024}")
          ESM_GZIP_KB=$(awk "BEGIN {printf \"%.2f\", $(gzip -c dist/index.js | wc -c)/1024}")
          CJS_GZIP_KB=$(awk "BEGIN {printf \"%.2f\", $(gzip -c dist/index.cjs | wc -c)/1024}")

          cat <<EOF
          üì¶ Bundle Sizes
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          ESM (index.js):       ${ESM_KB} KB (${ESM_GZIP_KB} KB gzipped)
          CommonJS (index.cjs):  ${CJS_KB} KB (${CJS_GZIP_KB} KB gzipped)
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 3

  build-example:
    name: üé® Build Example
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci --prefer-offline --no-audit

      - uses: actions/download-artifact@v4
        with:
          name: build-output
          path: dist/

      - run: npm run build:example

      - name: Verify example build
        run: |
          [ -f "example/dist/index.html" ] || { echo "‚ùå example/dist/index.html not found"; exit 1; }
          echo "‚úÖ Example build verified"

  ci-summary:
    name: ‚úÖ CI Summary
    runs-on: ubuntu-latest
    needs: [format-check, lint, type-check, test, build, build-example]
    if: always()
    steps:
      - name: Print CI summary
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "CI Summary"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          failed=0

          if [ "${{ needs.format-check.result }}" = "success" ]; then
            echo "  ‚úÖ Format"
          else
            echo "  ‚ùå Format"
            failed=1
          fi

          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "  ‚úÖ Lint"
          else
            echo "  ‚ùå Lint"
            failed=1
          fi

          if [ "${{ needs.type-check.result }}" = "success" ]; then
            echo "  ‚úÖ Types"
          else
            echo "  ‚ùå Types"
            failed=1
          fi

          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "  ‚úÖ Tests"
          else
            echo "  ‚ùå Tests"
            failed=1
          fi

          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "  ‚úÖ Build"
          else
            echo "  ‚ùå Build"
            failed=1
          fi

          if [ "${{ needs.build-example.result }}" = "success" ]; then
            echo "  ‚úÖ Example"
          else
            echo "  ‚ùå Example"
            failed=1
          fi

          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          exit $failed
