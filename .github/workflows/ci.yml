name: Lint, Test & Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  FORCE_COLOR: 1

jobs:
  format-check:
    name: ðŸ“ Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Check formatting
        run: npm run format:check

  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run linter
        run: npm run lint:ci

  type-check:
    name: ðŸ“˜ Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run type check
        run: npx tsc --noEmit

  test:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run tests
        run: npm test

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-coverage-${{ github.sha }}
          path: coverage/
          retention-days: 3
          if-no-files-found: warn

  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [format-check, lint, type-check, test]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build project
        run: npm run build

      - name: Verify build artifacts
        run: |
          echo "Checking build artifacts..."
          missing=0
          for file in dist/index.js dist/index.cjs dist/index.d.ts; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ $file not found"
              missing=1
            fi
          done

          if [ $missing -eq 1 ]; then
            exit 1
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All build artifacts verified"

      - name: Report bundle sizes
        run: |
          echo "ðŸ“¦ Bundle Size Analysis"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Calculate sizes
          ESM_SIZE=$(stat -c%s dist/index.js)
          CJS_SIZE=$(stat -c%s dist/index.cjs)
          ESM_KB=$(awk "BEGIN {printf \"%.2f\", $ESM_SIZE/1024}")
          CJS_KB=$(awk "BEGIN {printf \"%.2f\", $CJS_SIZE/1024}")
          ESM_GZIP=$(gzip -c dist/index.js | wc -c)
          CJS_GZIP=$(gzip -c dist/index.cjs | wc -c)
          ESM_GZIP_KB=$(awk "BEGIN {printf \"%.2f\", $ESM_GZIP/1024}")
          CJS_GZIP_KB=$(awk "BEGIN {printf \"%.2f\", $CJS_GZIP/1024}")

          # Display results
          printf "%-25s %8s KB (%6s KB gzipped)\n" "ESM (index.js):" "$ESM_KB" "$ESM_GZIP_KB"
          printf "%-25s %8s KB (%6s KB gzipped)\n" "CommonJS (index.cjs):" "$CJS_KB" "$CJS_GZIP_KB"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Create job summary
          {
            echo "## ðŸ“¦ Bundle Size Report"
            echo ""
            echo "| Format | Size | Gzipped |"
            echo "|--------|------|---------|"
            echo "| ESM | ${ESM_KB} KB | ${ESM_GZIP_KB} KB |"
            echo "| CommonJS | ${CJS_KB} KB | ${CJS_GZIP_KB} KB |"
          } >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ github.sha }}
          path: dist/
          retention-days: 3

  build-example:
    name: ðŸŽ¨ Build Example
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: [format-check, lint, type-check, test, build]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output-${{ github.sha }}
          path: dist/

      - name: Build example
        run: npm run build:example

      - name: Verify example build
        run: |
          if [ -f "example/dist/index.html" ]; then
            echo "âœ… example/dist/index.html verified"
            
            # Get example size info
            EXAMPLE_SIZE=$(du -sh example/dist 2>/dev/null | cut -f1 || echo "unknown")
            echo "ðŸ“Š Example build size: $EXAMPLE_SIZE"
          else
            echo "âŒ example/dist/index.html not found"
            exit 1
          fi

      - name: Upload example build
        uses: actions/upload-artifact@v4
        with:
          name: example-build-${{ github.sha }}
          path: example/dist/
          retention-days: 3

  ci-summary:
    name: âœ… CI Summary
    runs-on: ubuntu-latest
    needs: [format-check, lint, type-check, test, build, build-example]
    if: always()
    steps:
      - name: Generate CI summary
        run: |
          echo "# ðŸŽ¯ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Terminal output
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "CI Pipeline Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          failed=0

          if [ "${{ needs.format-check.result }}" = "success" ]; then
            echo "  âœ… Format"
            echo "| Format | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "  âŒ Format"
            echo "| Format | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            failed=1
          fi

          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "  âœ… Lint"
            echo "| Lint | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "  âŒ Lint"
            echo "| Lint | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            failed=1
          fi

          if [ "${{ needs.type-check.result }}" = "success" ]; then
            echo "  âœ… Types"
            echo "| Types | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "  âŒ Types"
            echo "| Types | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            failed=1
          fi

          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "  âœ… Tests"
            echo "| Tests | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "  âŒ Tests"
            echo "| Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            failed=1
          fi

          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "  âœ… Build"
            echo "| Build | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "  âŒ Build"
            echo "| Build | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            failed=1
          fi

          if [ "${{ needs.build-example.result }}" = "success" ]; then
            echo "  âœ… Example"
            echo "| Example | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "  âŒ Example"
            echo "| Example | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            failed=1
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $failed -eq 1 ]; then
            echo "**âŒ Pipeline Failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "**âœ… All Jobs Passed**" >> $GITHUB_STEP_SUMMARY
          fi
