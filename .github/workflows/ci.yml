name: 'Lint, Test & Build'

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test execution'
        type: boolean
        default: false
      skip_lint:
        description: 'Skip linting and formatting checks'
        type: boolean
        default: false
      force_build:
        description: 'Force build even if no source changes detected'
        type: boolean
        default: false
      force_publish:
        description: 'Force npm publish (will still check version changes)'
        type: boolean
        default: false
      run_example_build:
        description: 'Force example build'
        type: boolean
        default: false

concurrency:
  group: '${{ github.workflow }}-${{ github.ref }}'
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  FORCE_COLOR: 1

# Default permissions for all jobs
permissions:
  contents: read

# Since GitHub Actions doesn't support YAML anchors across the entire workflow,
# we'll use shell scripts and consistent patterns instead for maintainability

jobs:
  setup:
    name: 'âš¡ Setup & Cache'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      cache-hit: ${{ steps.cache-node-modules.outputs.cache-hit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - name: Restore node_modules cache
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-
            node_modules-${{ runner.os }}-${{ runner.arch }}-
      - name: Install dependencies (if cache miss)
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit
      - name: Verify installation
        run: |
          set -euo pipefail
          echo "âœ… Node modules ready"
          echo "ðŸ“¦ $(npm list --depth=0 2>/dev/null | grep -c '^[â”œâ””]' || echo '0') packages installed"

  format-check:
    name: 'ðŸ“ Format Check'
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ !inputs.skip_lint }}
    timeout-minutes: 3
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - name: Restore node_modules cache
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-
            node_modules-${{ runner.os }}-${{ runner.arch }}-
      - name: Install dependencies (if cache miss)
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit
      - run: npm run format:check

  lint:
    name: 'ðŸ” Lint'
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ !inputs.skip_lint }}
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - name: Restore node_modules cache
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-
            node_modules-${{ runner.os }}-${{ runner.arch }}-
      - name: Install dependencies (if cache miss)
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit
      - run: npm run lint:ci

  type-check:
    name: 'ðŸ“˜ Type Check'
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 3
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - name: Restore node_modules cache
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-
            node_modules-${{ runner.os }}-${{ runner.arch }}-
      - name: Install dependencies (if cache miss)
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit
      - run: npx tsc --noEmit

  test:
    name: 'ðŸ§ª Tests'
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ !inputs.skip_tests }}
    timeout-minutes: 3
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - name: Restore node_modules cache
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-
            node_modules-${{ runner.os }}-${{ runner.arch }}-
      - name: Install dependencies (if cache miss)
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit
      - run: npm test
      - name: Verify and upload test coverage
        if: always()
        run: |
          set -euo pipefail
          if [ ! -d "coverage" ] || [ -z "$(ls -A coverage)" ]; then
            echo "âš ï¸ Coverage directory is empty or doesn't exist"
          else
            echo "âœ… Coverage artifacts verified"
          fi
      - name: Upload test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'test-coverage-${{ github.job }}-${{ github.sha }}'
          path: coverage/
          retention-days: 7
          if-no-files-found: warn

  security-audit:
    name: 'ðŸ”’ Security Audit'
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 3
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - name: Restore node_modules cache
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-
            node_modules-${{ runner.os }}-${{ runner.arch }}-
      - name: Install dependencies (if cache miss)
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit
      - name: Run security audit
        run: npm audit --audit-level=high

  check-changes:
    name: 'ðŸ” Check Changed Files'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      build-main: '${{ steps.src.outputs.changed }}'
      build-example: '${{ steps.example.outputs.changed }}'
    steps:
      - name: Checkout repository (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set diff SHAs
        run: ./scripts/set-diff-shas.sh
      - name: Check ./src changes
        id: src
        run: ./scripts/check-changes.sh ./src "${{ inputs.force_build }}"
      - name: Check ./example changes
        id: example
        run: ./scripts/check-changes.sh ./example "${{ inputs.run_example_build }}"

  build:
    name: 'ðŸ—ï¸ Build'
    runs-on: ubuntu-latest
    needs:
      - setup
      - format-check
      - lint
      - type-check
      - test
      - security-audit
      - check-changes
    if: |
      always() && 
      !cancelled() && 
      !failure() && 
      (needs.check-changes.outputs.build-main == 'true' || inputs.force_build) &&
      (needs.format-check.result == 'success' || needs.format-check.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.type-check.result == 'success') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.security-audit.result == 'success')
    timeout-minutes: 10
    steps:
      - name: Checkout repository (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - *setup_node
      - *restore_node_modules
      - *install_deps
      - name: Compare bundle sizes (PR only)
        if: github.event_name == 'pull_request'
        run: ./scripts/compare-bundle-sizes.sh "${{ github.base_ref }}" "${{ github.sha }}"
      - name: Build library
        if: github.event_name != 'pull_request'
        run: npm run build
      - name: Verify and report build artifacts
        run: ./scripts/verify-build.sh
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: 'build-output-${{ github.job }}-${{ github.sha }}'
          path: dist/
          retention-days: 14
          if-no-files-found: error

  benchmark:
    name: 'âš¡ Performance Benchmark'
    runs-on: ubuntu-latest
    needs: [build]
    if: needs.build.result == 'success'
    timeout-minutes: 3
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: 'build-output-build-${{ github.sha }}'
          path: dist/
      - name: Run performance benchmarks
        run: ./scripts/benchmark.sh

  build-example:
    name: 'ðŸŽ¨ Build Example'
    runs-on: ubuntu-latest
    needs:
      - setup
      - format-check
      - lint
      - type-check
      - test
      - security-audit
      - build
      - check-changes
    if: |
      always() && 
      !cancelled() && 
      !failure() && 
      (needs.check-changes.outputs.build-example == 'true' || inputs.run_example_build) &&
      (needs.format-check.result == 'success' || needs.format-check.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.type-check.result == 'success') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.security-audit.result == 'success') &&
      (needs.build.result == 'success' || needs.build.result == 'skipped')
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
      - name: Restore node_modules cache
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node_modules-${{ runner.os }}-${{ runner.arch }}-node${{ env.NODE_VERSION }}-
            node_modules-${{ runner.os }}-${{ runner.arch }}-
      - name: Install dependencies (if cache miss)
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit
      - name: Download build artifacts (if available)
        if: needs.build.result == 'success'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: 'build-output-build-${{ github.sha }}'
          path: dist/
      - name: Build main library if needed
        run: |
          set -euo pipefail
          if [ ! -f "dist/index.js" ]; then
            echo "ðŸ—ï¸ Main build artifacts not found, building library..."
            npm run build
          else
            echo "âœ… Using existing build artifacts"
          fi
      - name: Build example
        run: npm run build:example
      - name: Verify and report example build
        run: |
          set -euo pipefail
          if [ ! -f "example/dist/index.html" ]; then
            echo "âŒ example/dist/index.html not found"
            exit 1
          fi

          if [ ! -d "example/dist/assets" ]; then
            echo "âŒ example/dist/assets directory not found"
            exit 1
          fi

          echo "âœ… example/dist/index.html verified"
          EXAMPLE_SIZE=$(du -sh example/dist 2>/dev/null | cut -f1 || echo "unknown")
          echo "ðŸ“Š Example build size: $EXAMPLE_SIZE"

          # Count assets
          ASSET_COUNT=$(find example/dist/assets -type f | wc -l)
          echo "ðŸ“ Assets: $ASSET_COUNT files"
      - name: Upload example build
        uses: actions/upload-artifact@v4
        with:
          name: 'example-build-${{ github.job }}-${{ github.sha }}'
          path: example/dist/
          retention-days: 7

  publish-npm:
    name: 'ðŸ“¦ Publish to npm'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs:
      - setup
      - format-check
      - lint
      - type-check
      - test
      - check-changes
    if: |
      always() && 
      !cancelled() && 
      !failure() && 
      ((github.ref == 'refs/heads/main' && github.event_name == 'push') || inputs.force_publish) &&
      (needs.format-check.result == 'success' || needs.format-check.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.type-check.result == 'success') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: npm
          registry-url: 'https://registry.npmjs.org'
      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            node_modules-${{ runner.os }}-${{ env.NODE_VERSION }}-
      - name: Check if version changed
        id: version-check
        run: ./scripts/check-version-changed.sh
      - name: Skip if version unchanged
        if: steps.version-check.outputs.changed == 'false'
        run: echo "â„¹ï¸ Version unchanged â€“ skipping npm publish"
      - name: Download build artifacts (if available)
        if: steps.version-check.outputs.changed == 'true'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: 'build-output-${{ github.sha }}'
          path: dist/
      - name: Publish to npm
        if: steps.version-check.outputs.changed == 'true'
        env:
          NODE_AUTH_TOKEN: '${{ secrets.NPM_TOKEN }}'
        run: |
          # Install dependencies if not cached
          if [ ! -d "node_modules" ] || [ "${{ needs.setup.outputs.cache-hit }}" != "true" ]; then
            npm ci --prefer-offline --no-audit
          fi
          # Only run build if we don't have artifacts from build job
          if [ ! -f "dist/index.js" ]; then
            echo "ðŸ—ï¸ Running build (no artifacts from build job)"
            npm run build
          else
            echo "âœ… Using existing build artifacts"
          fi
          npm publish --provenance --access public
      - name: Create Git tag
        if: steps.version-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version-check.outputs.version }}" -m "Release v${{ steps.version-check.outputs.version }}"
          git push origin "v${{ steps.version-check.outputs.version }}"

  pr-comment:
    name: 'ðŸ’¬ PR Comment'
    runs-on: ubuntu-latest
    needs:
      - setup
      - format-check
      - lint
      - type-check
      - test
      - security-audit
      - build
      - benchmark
      - build-example
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download build artifacts (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: 'build-output-build-${{ github.sha }}'
          path: dist/
      - name: Download coverage artifacts (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: 'test-coverage-test-${{ github.sha }}'
          path: coverage/
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Helper function for status emojis
            const getStatusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'ðŸš«';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };

            let comment = '## ðŸŽ¯ CI Results\n\n';

            // Job status table
            comment += '| Job | Status |\n';
            comment += '|-----|--------|\n';
            comment += `| Setup | ${getStatusEmoji('${{ needs.setup.result }}')} ${{ needs.setup.result }} |\n`;
            comment += `| Format Check | ${getStatusEmoji('${{ needs.format-check.result }}')} ${{ needs.format-check.result }} |\n`;
            comment += `| Lint | ${getStatusEmoji('${{ needs.lint.result }}')} ${{ needs.lint.result }} |\n`;
            comment += `| Type Check | ${getStatusEmoji('${{ needs.type-check.result }}')} ${{ needs.type-check.result }} |\n`;
            comment += `| Test | ${getStatusEmoji('${{ needs.test.result }}')} ${{ needs.test.result }} |\n`;
            comment += `| Build | ${getStatusEmoji('${{ needs.build.result }}')} ${{ needs.build.result }} |\n`;
            comment += `| Build Example | ${getStatusEmoji('${{ needs.build-example.result }}')} ${{ needs.build-example.result }} |\n`;

            // Bundle size info (if available)
            if (fs.existsSync('dist/index.js')) {
              comment += '\n## ðŸ“¦ Bundle Sizes\n\n';
              try {
                const esmSize = fs.statSync('dist/index.js').size;
                const cjsSize = fs.statSync('dist/index.cjs').size;
                const umdSize = fs.statSync('dist/index.umd.js').size;
                
                comment += '| Format | Size |\n';
                comment += '|--------|------|\n';
                comment += `| ESM | ${(esmSize/1024).toFixed(1)} KB |\n`;
                comment += `| CommonJS | ${(cjsSize/1024).toFixed(1)} KB |\n`;
                comment += `| UMD | ${(umdSize/1024).toFixed(1)} KB |\n`;
              } catch (e) {
                comment += '_Bundle size information unavailable_\n';
              }
            }

            // Coverage info (if available)
            if (fs.existsSync('coverage/coverage-final.json')) {
              comment += '\n## ðŸ§ª Test Coverage\n\n';
              try {
                const coverage = JSON.parse(fs.readFileSync('coverage/coverage-final.json', 'utf8'));
                let totalLines = 0, coveredLines = 0;
                for (const file in coverage) {
                  const fileCov = coverage[file];
                  totalLines += Object.keys(fileCov.s).length;
                  coveredLines += Object.values(fileCov.s).filter(hits => hits > 0).length;
                }
                const percentage = totalLines > 0 ? ((coveredLines / totalLines) * 100).toFixed(1) : '0';
                comment += `**Coverage:** ${percentage}% (${coveredLines}/${totalLines} lines)\n`;
              } catch (e) {
                comment += '_Coverage information unavailable_\n';
              }
            }

            comment += `\n---\n*CI run: [\`${context.sha.substring(0, 7)}\`](${context.payload.pull_request.html_url}/commits/${context.sha})*`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ðŸŽ¯ CI Results')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  ci-summary:
    name: 'âœ… CI Summary'
    runs-on: ubuntu-latest
    needs:
      - setup
      - format-check
      - lint
      - type-check
      - test
      - security-audit
      - build
      - benchmark
      - build-example
      - publish-npm
    if: always()
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download build artifacts (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: 'build-output-build-${{ github.sha }}'
          path: dist/
      - name: Generate CI summary
        run: |
          get_status_emoji() {
            case "$1" in
              "success") echo "âœ…" ;;
              "failure") echo "âŒ" ;;
              "cancelled") echo "ðŸš«" ;;
              "skipped") echo "â­ï¸" ;;
              *) echo "â“" ;;
            esac
          }

          format_duration() {
            local seconds=$1
            if [ "$seconds" -gt 60 ]; then
              printf "%dm %ds" $((seconds/60)) $((seconds%60))
            else
              printf "%ds" "$seconds"
            fi
          }

          echo "# ðŸŽ¯ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate workflow duration
          WORKFLOW_START="${{ github.event.repository.created_at }}"
          WORKFLOW_END=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Overall status
          overall_status="success"
          failed_jobs=""

          # Check each job result
          for job in "format-check:${{ needs.format-check.result }}" "lint:${{ needs.lint.result }}" "type-check:${{ needs.type-check.result }}" "test:${{ needs.test.result }}" "security-audit:${{ needs.security-audit.result }}" "build:${{ needs.build.result }}" "benchmark:${{ needs.benchmark.result }}" "build-example:${{ needs.build-example.result }}"; do
            job_name=$(echo "$job" | cut -d: -f1)
            job_result=$(echo "$job" | cut -d: -f2)
            if [ "$job_result" = "failure" ]; then
              overall_status="failure"
              failed_jobs="$failed_jobs $job_name"
            fi
          done

          echo "**Overall Status:** $(get_status_emoji "$overall_status") $overall_status" >> $GITHUB_STEP_SUMMARY
          [ -n "$failed_jobs" ] && echo "**Failed Jobs:**$failed_jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Job results table
          echo "## ðŸ“Š Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Estimated Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Format Check | $(get_status_emoji '${{ needs.format-check.result }}') ${{ needs.format-check.result }} | ~30s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint | $(get_status_emoji '${{ needs.lint.result }}') ${{ needs.lint.result }} | ~1m |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“˜ Type Check | $(get_status_emoji '${{ needs.type-check.result }}') ${{ needs.type-check.result }} | ~30s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Test | $(get_status_emoji '${{ needs.test.result }}') ${{ needs.test.result }} | ~45s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security Audit | $(get_status_emoji '${{ needs.security-audit.result }}') ${{ needs.security-audit.result }} | ~30s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | $(get_status_emoji '${{ needs.build.result }}') ${{ needs.build.result }} | ~1m |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Performance Benchmark | $(get_status_emoji '${{ needs.benchmark.result }}') ${{ needs.benchmark.result }} | ~30s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ Build Example | $(get_status_emoji '${{ needs.build-example.result }}') ${{ needs.build-example.result }} | ~30s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Publish npm | $(get_status_emoji '${{ needs.publish-npm.result }}') ${{ needs.publish-npm.result }} | ~45s |" >> $GITHUB_STEP_SUMMARY

          # Bundle size info (if build succeeded)
          if [[ "${{ needs.build.result }}" == "success" && -f "dist/index.js" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“¦ Bundle Sizes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            ESM_SIZE=$(stat -c%s dist/index.js 2>/dev/null || echo "0")
            CJS_SIZE=$(stat -c%s dist/index.cjs 2>/dev/null || echo "0") 
            UMD_SIZE=$(stat -c%s dist/index.umd.js 2>/dev/null || echo "0")
            
            if [ "$ESM_SIZE" -gt 0 ]; then
              ESM_KB=$(awk "BEGIN {printf \"%.1f\", $ESM_SIZE/1024}")
              CJS_KB=$(awk "BEGIN {printf \"%.1f\", $CJS_SIZE/1024}")
              UMD_KB=$(awk "BEGIN {printf \"%.1f\", $UMD_SIZE/1024}")
              
              ESM_GZIP=$(gzip -c dist/index.js | wc -c)
              CJS_GZIP=$(gzip -c dist/index.cjs | wc -c)
              UMD_GZIP=$(gzip -c dist/index.umd.js | wc -c)
              ESM_GZIP_KB=$(awk "BEGIN {printf \"%.1f\", $ESM_GZIP/1024}")
              CJS_GZIP_KB=$(awk "BEGIN {printf \"%.1f\", $CJS_GZIP/1024}")
              UMD_GZIP_KB=$(awk "BEGIN {printf \"%.1f\", $UMD_GZIP/1024}")
              
              echo "| Format | Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|------|---------|" >> $GITHUB_STEP_SUMMARY
              echo "| ESM | ${ESM_KB} KB | ${ESM_GZIP_KB} KB |" >> $GITHUB_STEP_SUMMARY
              echo "| CommonJS | ${CJS_KB} KB | ${CJS_GZIP_KB} KB |" >> $GITHUB_STEP_SUMMARY
              echo "| UMD | ${UMD_KB} KB | ${UMD_GZIP_KB} KB |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Workflow info
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ Workflow Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

          # Manual trigger options (if workflow_dispatch)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš™ï¸ Manual Trigger Options" >> $GITHUB_STEP_SUMMARY
            echo "- Skip Tests: ${{ inputs.skip_tests }}" >> $GITHUB_STEP_SUMMARY
            echo "- Skip Lint: ${{ inputs.skip_lint }}" >> $GITHUB_STEP_SUMMARY
            echo "- Force Build: ${{ inputs.force_build }}" >> $GITHUB_STEP_SUMMARY
            echo "- Force Publish: ${{ inputs.force_publish }}" >> $GITHUB_STEP_SUMMARY
            echo "- Run Example Build: ${{ inputs.run_example_build }}" >> $GITHUB_STEP_SUMMARY
          fi
